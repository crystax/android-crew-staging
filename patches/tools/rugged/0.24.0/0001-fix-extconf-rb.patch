diff -r --unified a/ext/rugged/extconf.rb b/ext/rugged/extconf.rb
--- a/ext/rugged/extconf.rb	2016-05-19 21:48:48.000000000 +0300
+++ b/ext/rugged/extconf.rb	2016-05-19 21:57:04.000000000 +0300
@@ -1,105 +1,39 @@
+# -*- ruby -*-
+
 require 'mkmf'
 
-RbConfig::MAKEFILE_CONFIG['CC'] = ENV['CC'] if ENV['CC']
+RbConfig::MAKEFILE_CONFIG['CC'] = ENV['CC']
 
-$CFLAGS << " #{ENV["CFLAGS"]}"
+$CFLAGS << " #{ENV["RUGGED_CFLAGS"]}"
 $CFLAGS << " -g"
 $CFLAGS << " -O3" unless $CFLAGS[/-O\d/]
 $CFLAGS << " -Wall -Wno-comment"
 
-def sys(cmd)
-  puts " -- #{cmd}"
-  unless ret = xsystem(cmd)
-    raise "ERROR: '#{cmd}' failed"
-  end
-  ret
-end
-
-def windows?
-  RbConfig::CONFIG['host_os'] =~ /mswin|mingw/
-end
-
-if !(MAKE = find_executable('gmake') || find_executable('make'))
-  abort "ERROR: GNU make is required to build Rugged."
-end
-
-CWD = File.expand_path(File.dirname(__FILE__))
-LIBGIT2_DIR = File.join(CWD, '..', '..', 'vendor', 'libgit2')
-
-if arg_config("--use-system-libraries", !!ENV['RUGGED_USE_SYSTEM_LIBRARIES'])
-  puts "Building Rugged using system libraries.\n"
+create_makefile("rugged")
 
-  dir_config('git2').any? or pkg_config('libgit2')
 
-  major = minor = nil
+makefile = ENV['RUGGED_MAKEFILE']
 
-  File.readlines(File.join(LIBGIT2_DIR, "include", "git2", "version.h")).each do |line|
-    if !major && (matches = line.match(/^#define LIBGIT2_VER_MAJOR ([0-9]+)$/))
-      major = matches[1]
-      next
-    end
-
-    if !minor && (matches = line.match(/^#define LIBGIT2_VER_MINOR ([0-9]+)$/))
-      minor = matches[1]
-      next
-    end
-
-    break if major && minor
+def remove_matched(line, regexs)
+  elems = []
+  line.split(' ').each do |e|
+    next if regexs.any? { |r| e =~ r }
+    elems << e
   end
+  elems.join(' ')
+end
 
-  try_compile(<<-SRC) or abort "libgit2 version is not compatible, expected ~> #{major}.#{minor}.0"
-#include <git2/version.h>
 
-#if LIBGIT2_VER_MAJOR != #{major} || LIBGIT2_VER_MINOR != #{minor}
-#error libgit2 version is not compatible
-#endif
-  SRC
-else
-  if !find_executable('cmake')
-    abort "ERROR: CMake is required to build Rugged."
-  end
+lines = File.read(makefile).split("\n")
+lines.each.with_index do |ln, ind|
+  case ln
+  when /^V = 0/
+    lines[ind] = "V = 1"
 
-  if !windows? && !find_executable('pkg-config')
-    abort "ERROR: pkg-config is required to build Rugged."
-  end
+  when /^ldflags\s*=/
+    lines[ind] = remove_matched(ln, [/-L\/usr\/local\/lib/])
 
-  Dir.chdir(LIBGIT2_DIR) do
-    Dir.mkdir("build") if !Dir.exists?("build")
-
-    Dir.chdir("build") do
-      sys("cmake .. -DBUILD_CLAR=OFF -DTHREADSAFE=ON -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_FLAGS=-fPIC -DCMAKE_BUILD_TYPE=RelWithDebInfo -G \"Unix Makefiles\"")
-      sys(MAKE)
-
-      # "normal" libraries (and libgit2 builds) get all these when they build but we're doing it
-      # statically so we put the libraries in by hand. It's important that we put the libraries themselves
-      # in $LIBS or the final linking stage won't pick them up
-      if windows?
-        $LDFLAGS << " " + "-L#{Dir.pwd}/deps/winhttp"
-        $LIBS << " -lwinhttp -lcrypt32 -lrpcrt4 -lole32"
-      else
-        pcfile = File.join(LIBGIT2_DIR, "build", "libgit2.pc")
-        $LDFLAGS << " " + `pkg-config --libs --static #{pcfile}`.strip
-      end
-    end
   end
-
-  # Prepend the vendored libgit2 build dir to the $DEFLIBPATH.
-  #
-  # By default, $DEFLIBPATH includes $(libpath), which usually points
-  # to something like /usr/lib for system ruby versions (not those
-  # installed through rbenv or rvm).
-  #
-  # This was causing system-wide libgit2 installations to be preferred
-  # over of our vendored libgit2 version when building rugged.
-  #
-  # By putting the path to the vendored libgit2 library at the front of
-  # $DEFLIBPATH, we can ensure that our bundled version is always used.
-  $DEFLIBPATH.unshift("#{LIBGIT2_DIR}/build")
-  dir_config('git2', "#{LIBGIT2_DIR}/include", "#{LIBGIT2_DIR}/build")
-end
-
-unless have_library 'git2' and have_header 'git2.h'
-  abort "ERROR: Failed to build libgit2"
 end
 
-create_makefile("rugged/rugged")
+File.write(makefile, "#{lines.join("\n")}\n")
